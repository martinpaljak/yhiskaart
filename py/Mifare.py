#!/usr/bin/python

#
# Copyright: Collin Mulliner <collin@mulliner.org>
# Web: http://www.mulliner.org/nfc/
#
# License: GPLv2
#

import Utils

class Mifare:
	def __init__(self, raw_data, is_hex = 1):
		self.__raw_data = []
		self.__data_only = []
		if (is_hex == 1):
			self.__raw_data = Utils.hex2bin(raw_data)
		else:
			self.__raw_data = raw_data
		done = 0
		pos = 4
		while done == 0: 
			s = pos * 16
			for i in range(0, 16):
				self.__data_only.append(self.__raw_data[s+i])
			pos = pos + 1
			if pos < 128 and pos % 4 == 3:
				#print "sec trailer"
				pos = pos + 1
			elif pos >= 128 and pos % 8 == 7:
				pos = pos + 1
			if pos * 16 >= len(self.__raw_data):
				#print "end: " + str(pos)
				done = 1
		
	def byteToBlock(self, b):
		block = b / 16
		if b % 16 > 0:
			block = block + 1
		return block
		
	def getSize(self):
		return len(self.__raw_data)
	
	def getDataSize(self):
		return len(self.__data_only)
		
	def getBlock(self, block_number):
		of = block_number * 16
		block = self.__raw_data[of:of+16]
		return block
	
	def getData(self, start = 0, end = -1):
		if end == -1:
			end = len(self.__data_only)
		data = self.__data_only[start:end]
		return data
		
	def setData(self, data):
		self.__data_only = data

	def modData(self, data, offset):
		pass

	def getDataHex(self, start = 0, end = -1):
		if end == -1:
			end = len(self.__data_only)
		data = self.__data_only[start:end]
		d = Utils.bin2hex(data)
		return d

if __name__ == "__main__":
	import NFCTagType1
	import NDEFMessage
	import SpReader
	data = "DA60C7136E88040047C12575610028064E0103E103E103E1000000000000000000000000000000000000000000000000000000000000787788C10000000000000365D1026053709101385500687474703A2F2F7761702E636D72642E64652F6E6663776F726D2F3F75726C3D687474700000000000007F0788400000000000002533412532462532467761702E726D762E64655101205405656E2D5553687474703A2F2F7761702E726D762E64650D0D0000000000007F0788400000000000000D0D0D0D0D0D2EFE000000000000000066666666666666666666666666666666666666666666666666666666666666610000000000007F07884000000000000067676767676767676767676767676767676767676767676767676767676767676767676767676767676767674100736D0000000000007F078840000000000000623A2F2F25257325257325256E2564252578252578257325257325257825256E2578256425782563FE000000000000000000000000007F0788400000000000004141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141410000000000007F07884000000000000041414141414141414141414141414141414141414141414141FE000000000000414141414141414141414141414141410000000000007F0788400000000000004141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141410000000000007F0788400000000000004141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141410000000000007F0788400000000000004141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141410000000000007F0788400000000000004141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141410000000000007F0788400000000000004141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141410000000000007F0788400000000000004141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141410000000000007F0788400000000000004141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141410000000000007F0788400000000000004141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141FE0000000000007F078840000000000000"

	mf1 = Mifare(data)
	print "Total Size: " + str(mf1.getSize())
	print mf1.getBlock(3)
	d = mf1.getData()
	print mf1.getDataSize()
	print mf1.getDataHex()
	nt = NFCTagType1.NFCTagType1()
	nt.fromRawData(d, 0)
	n = nt.getNDEF()
	sp = SpReader.SpReader(n, 0)
